<!-- トースト通知コンテナ -->
<div id="toast-container" style="position:fixed; top:20px; right:20px; z-index:10000; display:flex; flex-direction:column; gap:10px; max-width:400px;"></div>

<style>
.toast {
    background: var(--pico-card-background-color, #fff);
    border-radius: 6px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    padding: 1rem 1.25rem;
    display: flex;
    align-items: center;
    gap: 12px;
    animation: toastSlideIn 0.3s ease-out;
    border-left: 4px solid #ccc;
}
.toast.success { border-left-color: #10b981; }
.toast.error   { border-left-color: #ef4444; }
.toast .toast-icon { font-size: 1.2rem; flex-shrink: 0; }
.toast.success .toast-icon { color: #10b981; }
.toast.error   .toast-icon { color: #ef4444; }
.toast.removing { animation: toastSlideOut 0.3s ease-in forwards; }
@keyframes toastSlideIn  { from { transform:translateX(400px); opacity:0; } to { transform:translateX(0); opacity:1; } }
@keyframes toastSlideOut { from { transform:translateX(0); opacity:1; } to { transform:translateX(400px); opacity:0; } }
</style>

<dialog id="scheduleSettingsDialog">
    <!-- ダイアログ内トーストコンテナ（トップレイヤー内に描画される） -->
    <div id="dialog-toast-container" style="position:fixed; top:20px; right:20px; z-index:10000; display:flex; flex-direction:column; gap:10px; max-width:400px;"></div>
    <article style="max-width: 640px; margin: auto; display: flex; flex-direction: column; max-height: 80vh; overflow: hidden;">
        <header style="flex-shrink: 0;">
            <button aria-label="Close" rel="prev" onclick="document.getElementById('scheduleSettingsDialog').close()"></button>
            <h3>設定</h3>
        </header>

        <!-- タブナビゲーション -->
        <div class="settings-tabs" style="flex-shrink: 0; display: flex; gap: 0; border-bottom: 2px solid var(--pico-muted-border-color); padding: 0 var(--pico-block-spacing-horizontal); margin-bottom: 0;">
            <a class="tab active" data-tab="schedule" onclick="switchTab('schedule')"
               style="border-bottom: 2px solid var(--pico-primary); margin-bottom: -2px; padding: 0.5rem 1rem; cursor: pointer; font-weight: bold; color: var(--pico-primary); font-size: 0.875rem; text-decoration: none; white-space: nowrap;">
                観測スケジュール</a>
            <a class="tab" data-tab="automation" onclick="switchTab('automation')"
               style="border-bottom: 2px solid transparent; margin-bottom: -2px; padding: 0.5rem 1rem; cursor: pointer; font-size: 0.875rem; text-decoration: none; white-space: nowrap;">
                自動実行</a>
            <a class="tab" data-tab="detection" onclick="switchTab('detection')"
               style="border-bottom: 2px solid transparent; margin-bottom: -2px; padding: 0.5rem 1rem; cursor: pointer; font-size: 0.875rem; text-decoration: none; white-space: nowrap;">
                検出パラメータ</a>
            <a class="tab" data-tab="system" onclick="switchTab('system')"
               style="border-bottom: 2px solid transparent; margin-bottom: -2px; padding: 0.5rem 1rem; cursor: pointer; font-size: 0.875rem; text-decoration: none; white-space: nowrap;">
                システム</a>
        </div>

        <div style="flex: 1; overflow-y: auto; padding: 0 var(--pico-block-spacing-horizontal);">

        <!-- Tab 1: 観測スケジュール -->
        <div class="tab-panel active" id="tab-schedule" style="margin-top: 1rem;">
        <form id="scheduleSettingsForm" onsubmit="return false;">
            <fieldset>
                <legend>開始時刻</legend>
                <label for="startMode">モード</label>
                <select id="startMode" name="start_mode" onchange="toggleStartFields()">
                    <option value="fixed">固定時刻</option>
                    <option value="twilight">天文薄明（自動）</option>
                    <option value="twilight_offset">天文薄明＋オフセット</option>
                </select>
                <div id="startFixedFields">
                    <label for="startTime">開始時刻</label>
                    <input type="time" id="startTime" name="start_time" value="22:00">
                </div>
                <div id="startOffsetFields" style="display:none;">
                    <label for="startOffset">オフセット（分）</label>
                    <input type="number" id="startOffset" name="start_offset_minutes" value="0" step="5" min="-120" max="120">
                    <small>負の値 = 薄明終了より早く開始、正の値 = 遅く開始</small>
                </div>
            </fieldset>

            <fieldset>
                <legend>終了時刻</legend>
                <label for="endMode">モード</label>
                <select id="endMode" name="end_mode" onchange="toggleEndFields()">
                    <option value="fixed">固定時刻</option>
                    <option value="twilight">天文薄明（自動）</option>
                    <option value="twilight_offset">天文薄明＋オフセット</option>
                </select>
                <div id="endFixedFields">
                    <label for="endTime">終了時刻</label>
                    <input type="time" id="endTime" name="end_time" value="06:00">
                </div>
                <div id="endOffsetFields" style="display:none;">
                    <label for="endOffset">オフセット（分）</label>
                    <input type="number" id="endOffset" name="end_offset_minutes" value="0" step="5" min="-120" max="120">
                    <small>負の値 = 薄明開始より早く終了、正の値 = 遅く終了</small>
                </div>
            </fieldset>

            <fieldset>
                <legend>観測地点</legend>
                <label for="locationMode">位置情報</label>
                <select id="locationMode" name="location_mode" onchange="toggleLocationFields()">
                    <option value="preset">都道府県プリセット</option>
                    <option value="custom">カスタム座標</option>
                </select>
                <div id="presetFields">
                    <label for="prefecture">都道府県</label>
                    <select id="prefecture" name="prefecture">
                        <option value="">読み込み中...</option>
                    </select>
                </div>
                <div id="customFields" style="display:none;">
                    <div class="grid">
                        <label>
                            緯度
                            <input type="number" id="latitude" name="latitude" step="0.0001" min="-90" max="90" placeholder="35.6762">
                        </label>
                        <label>
                            経度
                            <input type="number" id="longitude" name="longitude" step="0.0001" min="-180" max="180" placeholder="139.6503">
                        </label>
                    </div>
                </div>
            </fieldset>

            <fieldset>
                <legend>プレビュー</legend>
                <button type="button" class="secondary" onclick="previewSchedule()">今夜のスケジュールを確認</button>
                <div id="previewResult" style="display:none; margin-top:0.5rem;">
                    <small>
                        <span id="previewDate"></span>:
                        <strong><span id="previewStart"></span></strong> 〜
                        <strong><span id="previewEnd"></span></strong>
                    </small>
                </div>
            </fieldset>
            <button type="button" class="outline contrast" onclick="resetSettings('schedule')" style="width:auto; font-size:0.8rem; padding:0.4rem 0.8rem;">デフォルトに戻す</button>
        </form>
        </div>

        <!-- Tab 2: 自動実行 -->
        <div class="tab-panel" id="tab-automation" style="display: none; margin-top: 1rem;">
        <form id="automationSettingsForm" onsubmit="return false;">
            <fieldset>
                <legend>パイプライン実行間隔</legend>
                <label for="intervalMinutes">実行間隔</label>
                <select id="intervalMinutes" name="interval_minutes" onchange="toggleIntervalWarning()">
                    <option value="0">無効（スケジューラ停止）</option>
                    <option value="10">10分</option>
                    <option value="15">15分</option>
                    <option value="20">20分</option>
                    <option value="25">25分</option>
                    <option value="30">30分</option>
                    <option value="45">45分</option>
                    <option value="60" selected>1時間</option>
                    <option value="120">2時間</option>
                    <option value="180">3時間</option>
                    <option value="360">6時間</option>
                    <option value="720">12時間</option>
                </select>
                <small>観測時間帯内にこの間隔でパイプラインを自動実行します。</small>
                <div id="intervalWarning" style="display:none; margin-top:0.5rem; padding:0.6rem 0.8rem; background:var(--pico-mark-background-color, #fff3cd); border-radius:4px; font-size:0.8rem; line-height:1.5;">
                    <strong>&#9888; 注意:</strong> ネットワーク障害やクリップ数が多い場合、パイプライン実行が設定間隔を超えることがあります。実行が完了しないまま次のサイクルに入ると、そのサイクルはスキップされます。通常運用では20分以上を推奨します。
                </div>
            </fieldset>

            <fieldset>
                <legend>スケジューラ状態</legend>
                <div id="schedulerStatusInfo">
                    <div style="display: grid; grid-template-columns: auto 1fr; gap: 0.25rem 1rem; font-size: 0.875rem;">
                        <span>状態:</span>
                        <span id="schedulerStatusValue">-</span>
                        <span>最終実行:</span>
                        <span id="schedulerLastRun">-</span>
                        <span>最終結果:</span>
                        <span id="schedulerLastResult">-</span>
                        <span>検出数:</span>
                        <span id="schedulerLastDetections">-</span>
                        <span>次回予定:</span>
                        <span id="schedulerNextRun">-</span>
                    </div>
                    <button type="button" class="secondary outline" onclick="refreshSchedulerStatus()" style="margin-top: 0.5rem; width: auto;">
                        状態を更新
                    </button>
                </div>
            </fieldset>
            <button type="button" class="outline contrast" onclick="resetSettings('schedule')" style="width:auto; font-size:0.8rem; padding:0.4rem 0.8rem;">デフォルトに戻す</button>
        </form>
        </div>

        <!-- Tab 3: 検出パラメータ -->
        <div class="tab-panel" id="tab-detection" style="display: none; margin-top: 1rem;">
            <form id="detectionSettingsForm" onsubmit="return false;">
                <div class="grid">
                    <label>
                        最小直線長
                        <input type="number" id="det-min-line-length" min="1" max="500" step="1">
                        <small>min_line_length</small>
                    </label>
                    <label>
                        Hough投票閾値
                        <input type="number" id="det-hough-threshold" min="1" max="500" step="1">
                        <small>hough_threshold</small>
                    </label>
                </div>
                <div class="grid">
                    <label>
                        Canny下限閾値
                        <input type="number" id="det-canny-threshold1" min="1" max="500" step="1">
                        <small>canny_threshold1</small>
                    </label>
                    <label>
                        Canny上限閾値
                        <input type="number" id="det-canny-threshold2" min="1" max="500" step="1">
                        <small>canny_threshold2</small>
                    </label>
                </div>
                <div class="grid">
                    <label>
                        最大ギャップ
                        <input type="number" id="det-max-line-gap" min="0" max="100" step="1">
                        <small>max_line_gap</small>
                    </label>
                    <label>
                        最低輝度
                        <input type="number" id="det-min-line-brightness" min="0" max="255" step="0.1">
                        <small>min_line_brightness</small>
                    </label>
                </div>
                <label>
                    下部除外率（%）
                    <input type="number" id="det-exclude-bottom-pct" min="0" max="50" step="0.1">
                    <small>exclude_bottom_pct（0〜50）</small>
                </label>
                <button type="button" class="outline contrast" onclick="resetSettings('detection')" style="width:auto; font-size:0.8rem; padding:0.4rem 0.8rem;">デフォルトに戻す</button>
            </form>
        </div>

        <!-- Tab 4: システム -->
        <div class="tab-panel" id="tab-system" style="display: none; margin-top: 1rem;">
        <form id="systemSettingsForm" onsubmit="return false;">
            <fieldset>
                <legend>定期再起動</legend>
                <label>
                    <input type="checkbox" id="rebootEnabled" role="switch">
                    定期再起動を有効にする
                </label>
                <div id="rebootTimeFields">
                    <label for="rebootTime">再起動時刻</label>
                    <input type="time" id="rebootTime" value="12:00">
                    <small>観測時間帯外に1日1回、指定時刻にシステムを再起動します。</small>
                </div>
            </fieldset>
            <button type="button" class="outline contrast" onclick="resetSettings('system')" style="width:auto; font-size:0.8rem; padding:0.4rem 0.8rem;">デフォルトに戻す</button>
        </form>
        </div>

        </div>

        <footer style="flex-shrink: 0;">
            <button class="secondary" onclick="document.getElementById('scheduleSettingsDialog').close()">閉じる</button>
            <button id="saveSettingsBtn" onclick="saveSettings()">保存</button>
        </footer>
    </article>
</dialog>

<script>
/* ── トースト通知 ────────────────────────────────── */
function showToast(message, type) {
    var dialog = document.getElementById('scheduleSettingsDialog');
    var container = dialog.open
        ? document.getElementById('dialog-toast-container')
        : document.getElementById('toast-container');
    var toast = document.createElement('div');
    toast.className = 'toast ' + type;
    var icon = type === 'success' ? '\u2713' : '\u2715';
    toast.innerHTML = '<span class="toast-icon">' + icon + '</span><span>' + message + '</span>';
    container.appendChild(toast);
    setTimeout(function() {
        toast.classList.add('removing');
        setTimeout(function() { if (toast.parentNode) container.removeChild(toast); }, 300);
    }, 4000);
}

/* ── タブ切り替え ────────────────────────────────── */
function switchTab(tabName) {
    document.querySelectorAll('.settings-tabs .tab').forEach(function(btn) {
        if (btn.getAttribute('data-tab') === tabName) {
            btn.style.borderBottomColor = 'var(--pico-primary)';
            btn.style.color = 'var(--pico-primary)';
            btn.style.fontWeight = 'bold';
            btn.classList.add('active');
        } else {
            btn.style.borderBottomColor = 'transparent';
            btn.style.color = '';
            btn.style.fontWeight = '';
            btn.classList.remove('active');
        }
    });
    document.querySelectorAll('.tab-panel').forEach(function(panel) {
        panel.style.display = 'none';
        panel.classList.remove('active');
    });
    var target = document.getElementById('tab-' + tabName);
    if (target) {
        target.style.display = '';
        target.classList.add('active');
    }
}

/* ── フィールド表示切り替え ──────────────────────── */
function toggleStartFields() {
    var mode = document.getElementById('startMode').value;
    document.getElementById('startFixedFields').style.display = mode === 'fixed' ? '' : 'none';
    document.getElementById('startOffsetFields').style.display = mode === 'twilight_offset' ? '' : 'none';
}

function toggleEndFields() {
    var mode = document.getElementById('endMode').value;
    document.getElementById('endFixedFields').style.display = mode === 'fixed' ? '' : 'none';
    document.getElementById('endOffsetFields').style.display = mode === 'twilight_offset' ? '' : 'none';
}

function toggleLocationFields() {
    var mode = document.getElementById('locationMode').value;
    document.getElementById('presetFields').style.display = mode === 'preset' ? '' : 'none';
    document.getElementById('customFields').style.display = mode === 'custom' ? '' : 'none';
}

/* ── 実行間隔の注意表示 ────────────────────────────── */
function toggleIntervalWarning() {
    var val = parseInt(document.getElementById('intervalMinutes').value, 10);
    var warn = document.getElementById('intervalWarning');
    warn.style.display = (val > 0 && val <= 15) ? '' : 'none';
}

/* ── スケジューラ状態 ────────────────────────────── */
function refreshSchedulerStatus() {
    fetch('/api/scheduler/status')
        .then(function(r) { return r.json(); })
        .then(function(s) {
            var statusText = s.enabled ? (s.pipeline_running ? '実行中' : '待機中') : '無効';
            if (s.in_observation_window) statusText += '（観測時間帯内）';
            document.getElementById('schedulerStatusValue').textContent = statusText;
            document.getElementById('schedulerLastRun').textContent = s.last_run_at || '-';
            document.getElementById('schedulerLastResult').textContent = s.last_run_result || '-';
            document.getElementById('schedulerLastDetections').textContent = s.last_run_at ? String(s.last_run_detections) : '-';
            document.getElementById('schedulerNextRun').textContent = s.next_run_at || '-';
        });
}

/* ── 設定ダイアログ Open ─────────────────────────── */
function openSettings() {
    var dialog = document.getElementById('scheduleSettingsDialog');
    dialog.showModal();
    switchTab('schedule');
    document.getElementById('previewResult').style.display = 'none';

    fetch('/api/settings/prefectures')
        .then(function(r) { return r.json(); })
        .then(function(prefs) {
            var sel = document.getElementById('prefecture');
            sel.innerHTML = '';
            prefs.forEach(function(p) {
                var opt = document.createElement('option');
                opt.value = p.name;
                opt.textContent = p.name;
                sel.appendChild(opt);
            });
            return loadAllSettings();
        });
    refreshSchedulerStatus();
}

/* ── 全設定を UI にロード ────────────────────────── */
function loadAllSettings() {
    return Promise.all([
        fetch('/api/settings/schedule').then(function(r) { return r.json(); }),
        fetch('/api/settings/detection').then(function(r) { return r.json(); }),
        fetch('/api/settings/system').then(function(r) { return r.json(); }),
    ]).then(function(results) {
        populateScheduleFields(results[0]);
        populateDetectionFields(results[1]);
        populateSystemFields(results[2]);
    });
}

function populateScheduleFields(s) {
    document.getElementById('startMode').value = s.start_mode || 'fixed';
    document.getElementById('startTime').value = s.start_time || '22:00';
    document.getElementById('startOffset').value = s.start_offset_minutes || '0';
    document.getElementById('endMode').value = s.end_mode || 'fixed';
    document.getElementById('endTime').value = s.end_time || '06:00';
    document.getElementById('endOffset').value = s.end_offset_minutes || '0';
    document.getElementById('locationMode').value = s.location_mode || 'preset';
    document.getElementById('prefecture').value = s.prefecture || '';
    document.getElementById('latitude').value = s.latitude || '';
    document.getElementById('longitude').value = s.longitude || '';
    document.getElementById('intervalMinutes').value = s.interval_minutes || '60';
    toggleStartFields();
    toggleEndFields();
    toggleLocationFields();
    toggleIntervalWarning();
}

function populateDetectionFields(d) {
    document.getElementById('det-min-line-length').value = d.min_line_length;
    document.getElementById('det-canny-threshold1').value = d.canny_threshold1;
    document.getElementById('det-canny-threshold2').value = d.canny_threshold2;
    document.getElementById('det-hough-threshold').value = d.hough_threshold;
    document.getElementById('det-max-line-gap').value = d.max_line_gap;
    document.getElementById('det-min-line-brightness').value = d.min_line_brightness;
    document.getElementById('det-exclude-bottom-pct').value = d.exclude_bottom_pct;
}

function populateSystemFields(sys) {
    document.getElementById('rebootEnabled').checked = (sys.reboot_enabled === 'true' || sys.reboot_enabled === '1');
    document.getElementById('rebootTime').value = sys.reboot_time || '12:00';
}

/* ── 保存 ────────────────────────────────────────── */
function saveSettings() {
    var btn = document.getElementById('saveSettingsBtn');
    var origText = btn.textContent;
    btn.disabled = true;
    btn.setAttribute('aria-busy', 'true');
    btn.textContent = '保存中...';

    var scheduleData = {
        start_mode: document.getElementById('startMode').value,
        start_time: document.getElementById('startTime').value,
        start_offset_minutes: document.getElementById('startOffset').value,
        end_mode: document.getElementById('endMode').value,
        end_time: document.getElementById('endTime').value,
        end_offset_minutes: document.getElementById('endOffset').value,
        location_mode: document.getElementById('locationMode').value,
        prefecture: document.getElementById('prefecture').value,
        latitude: document.getElementById('latitude').value || '',
        longitude: document.getElementById('longitude').value || '',
        interval_minutes: document.getElementById('intervalMinutes').value,
    };
    var detectionData = {
        min_line_length: document.getElementById('det-min-line-length').value,
        canny_threshold1: document.getElementById('det-canny-threshold1').value,
        canny_threshold2: document.getElementById('det-canny-threshold2').value,
        hough_threshold: document.getElementById('det-hough-threshold').value,
        max_line_gap: document.getElementById('det-max-line-gap').value,
        min_line_brightness: document.getElementById('det-min-line-brightness').value,
        exclude_bottom_pct: document.getElementById('det-exclude-bottom-pct').value,
    };
    var systemData = {
        reboot_enabled: document.getElementById('rebootEnabled').checked ? 'true' : 'false',
        reboot_time: document.getElementById('rebootTime').value,
    };

    function putWithDetail(url, data, label) {
        return fetch(url, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data),
        }).then(function(r) {
            if (!r.ok) return r.text().then(function(body) {
                var detail = label;
                try { detail = label + ': ' + JSON.parse(body).detail; } catch(e) {}
                throw new Error(detail);
            });
            return r.json();
        });
    }

    Promise.all([
        putWithDetail('/api/settings/schedule', scheduleData, 'スケジュール設定'),
        putWithDetail('/api/settings/detection', detectionData, '検出パラメータ'),
        putWithDetail('/api/settings/system', systemData, 'システム設定'),
    ])
    .then(function() {
        btn.disabled = false;
        btn.setAttribute('aria-busy', 'false');
        btn.textContent = origText;
        showToast('設定を保存しました', 'success');
    })
    .catch(function(err) {
        btn.disabled = false;
        btn.setAttribute('aria-busy', 'false');
        btn.textContent = origText;
        showToast('保存に失敗しました: ' + err.message, 'error');
        console.error('Settings save error:', err);
    });
}

/* ── デフォルトにリセット ────────────────────────── */
function resetSettings(category) {
    var labels = { schedule: '観測スケジュール・自動実行', detection: '検出パラメータ', system: 'システム' };
    var label = labels[category] || category;
    if (!confirm(label + ' の設定をデフォルトに戻しますか？')) return;

    fetch('/api/settings/' + category, { method: 'DELETE' })
        .then(function(r) {
            if (!r.ok) throw new Error('リセット失敗');
            return r.json();
        })
        .then(function() {
            showToast(label + ' をデフォルトに戻しました', 'success');
            return loadAllSettings();
        })
        .then(function() {
            refreshSchedulerStatus();
        })
        .catch(function(err) {
            showToast('リセットに失敗しました: ' + err.message, 'error');
        });
}

/* ── プレビュー ──────────────────────────────────── */
function previewSchedule() {
    var data = {
        start_mode: document.getElementById('startMode').value,
        start_time: document.getElementById('startTime').value,
        start_offset_minutes: document.getElementById('startOffset').value,
        end_mode: document.getElementById('endMode').value,
        end_time: document.getElementById('endTime').value,
        end_offset_minutes: document.getElementById('endOffset').value,
        location_mode: document.getElementById('locationMode').value,
        prefecture: document.getElementById('prefecture').value,
        latitude: document.getElementById('latitude').value || '',
        longitude: document.getElementById('longitude').value || '',
    };
    fetch('/api/settings/schedule', {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data),
    })
    .then(function() {
        return fetch('/api/settings/schedule/preview');
    })
    .then(function(r) { return r.json(); })
    .then(function(p) {
        document.getElementById('previewDate').textContent = p.date_str;
        document.getElementById('previewStart').textContent = p.start_time;
        document.getElementById('previewEnd').textContent = p.end_time;
        document.getElementById('previewResult').style.display = '';
    });
}
</script>
