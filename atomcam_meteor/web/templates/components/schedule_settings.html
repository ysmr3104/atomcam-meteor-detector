<dialog id="scheduleSettingsDialog">
    <article style="max-width: 600px; margin: auto; display: flex; flex-direction: column; max-height: 80vh; overflow: hidden;">
        <header style="flex-shrink: 0;">
            <button aria-label="Close" rel="prev" onclick="document.getElementById('scheduleSettingsDialog').close()"></button>
            <h3>観測スケジュール設定</h3>
        </header>

        <div style="flex: 1; overflow-y: auto; padding: 0 var(--pico-block-spacing-horizontal);">
        <form id="scheduleSettingsForm" onsubmit="return false;">
            <!-- 開始時刻セクション -->
            <fieldset>
                <legend>開始時刻</legend>
                <label for="startMode">モード</label>
                <select id="startMode" name="start_mode" onchange="toggleStartFields()">
                    <option value="fixed">固定時刻</option>
                    <option value="twilight">天文薄明（自動）</option>
                    <option value="twilight_offset">天文薄明＋オフセット</option>
                </select>
                <div id="startFixedFields">
                    <label for="startTime">開始時刻</label>
                    <input type="time" id="startTime" name="start_time" value="22:00">
                </div>
                <div id="startOffsetFields" style="display:none;">
                    <label for="startOffset">オフセット（分）</label>
                    <input type="number" id="startOffset" name="start_offset_minutes" value="0" step="5" min="-120" max="120">
                    <small>負の値 = 薄明終了より早く開始、正の値 = 遅く開始</small>
                </div>
            </fieldset>

            <!-- 終了時刻セクション -->
            <fieldset>
                <legend>終了時刻</legend>
                <label for="endMode">モード</label>
                <select id="endMode" name="end_mode" onchange="toggleEndFields()">
                    <option value="fixed">固定時刻</option>
                    <option value="twilight">天文薄明（自動）</option>
                    <option value="twilight_offset">天文薄明＋オフセット</option>
                </select>
                <div id="endFixedFields">
                    <label for="endTime">終了時刻</label>
                    <input type="time" id="endTime" name="end_time" value="06:00">
                </div>
                <div id="endOffsetFields" style="display:none;">
                    <label for="endOffset">オフセット（分）</label>
                    <input type="number" id="endOffset" name="end_offset_minutes" value="0" step="5" min="-120" max="120">
                    <small>負の値 = 薄明開始より早く終了、正の値 = 遅く終了</small>
                </div>
            </fieldset>

            <!-- 観測地点セクション -->
            <fieldset>
                <legend>観測地点</legend>
                <label for="locationMode">位置情報</label>
                <select id="locationMode" name="location_mode" onchange="toggleLocationFields()">
                    <option value="preset">都道府県プリセット</option>
                    <option value="custom">カスタム座標</option>
                </select>
                <div id="presetFields">
                    <label for="prefecture">都道府県</label>
                    <select id="prefecture" name="prefecture">
                        <option value="">読み込み中...</option>
                    </select>
                </div>
                <div id="customFields" style="display:none;">
                    <div class="grid">
                        <label>
                            緯度
                            <input type="number" id="latitude" name="latitude" step="0.0001" min="-90" max="90" placeholder="35.6762">
                        </label>
                        <label>
                            経度
                            <input type="number" id="longitude" name="longitude" step="0.0001" min="-180" max="180" placeholder="139.6503">
                        </label>
                    </div>
                </div>
            </fieldset>

            <!-- プレビューセクション -->
            <fieldset>
                <legend>プレビュー</legend>
                <button type="button" class="secondary" onclick="previewSchedule()">今夜のスケジュールを確認</button>
                <div id="previewResult" style="display:none; margin-top:0.5rem;">
                    <small>
                        <span id="previewDate"></span>:
                        <strong><span id="previewStart"></span></strong> 〜
                        <strong><span id="previewEnd"></span></strong>
                    </small>
                </div>
            </fieldset>
        </form>

        <details id="detectionSettingsSection" style="margin-top:1rem;">
            <summary style="cursor:pointer; font-weight:bold;">検出パラメータ</summary>
            <form id="detectionSettingsForm" onsubmit="return false;" style="margin-top:0.5rem;">
                <div class="grid">
                    <label>
                        最小直線長
                        <input type="number" id="det-min-line-length" min="1" max="500" step="1">
                        <small>min_line_length</small>
                    </label>
                    <label>
                        Hough投票閾値
                        <input type="number" id="det-hough-threshold" min="1" max="500" step="1">
                        <small>hough_threshold</small>
                    </label>
                </div>
                <div class="grid">
                    <label>
                        Canny下限閾値
                        <input type="number" id="det-canny-threshold1" min="1" max="500" step="1">
                        <small>canny_threshold1</small>
                    </label>
                    <label>
                        Canny上限閾値
                        <input type="number" id="det-canny-threshold2" min="1" max="500" step="1">
                        <small>canny_threshold2</small>
                    </label>
                </div>
                <div class="grid">
                    <label>
                        最大ギャップ
                        <input type="number" id="det-max-line-gap" min="0" max="100" step="1">
                        <small>max_line_gap</small>
                    </label>
                    <label>
                        最低輝度
                        <input type="number" id="det-min-line-brightness" min="0" max="255" step="0.1">
                        <small>min_line_brightness</small>
                    </label>
                </div>
                <label>
                    下部除外率（%）
                    <input type="number" id="det-exclude-bottom-pct" min="0" max="50" step="0.1">
                    <small>exclude_bottom_pct（0〜50）</small>
                </label>
            </form>
        </details>
        </div>

        <footer style="flex-shrink: 0;">
            <button class="secondary" onclick="document.getElementById('scheduleSettingsDialog').close()">キャンセル</button>
            <button onclick="saveSettings()">保存</button>
        </footer>
    </article>
</dialog>

<script>
function toggleStartFields() {
    var mode = document.getElementById('startMode').value;
    document.getElementById('startFixedFields').style.display =
        mode === 'fixed' ? '' : 'none';
    document.getElementById('startOffsetFields').style.display =
        mode === 'twilight_offset' ? '' : 'none';
}

function toggleEndFields() {
    var mode = document.getElementById('endMode').value;
    document.getElementById('endFixedFields').style.display =
        mode === 'fixed' ? '' : 'none';
    document.getElementById('endOffsetFields').style.display =
        mode === 'twilight_offset' ? '' : 'none';
}

function toggleLocationFields() {
    var mode = document.getElementById('locationMode').value;
    document.getElementById('presetFields').style.display =
        mode === 'preset' ? '' : 'none';
    document.getElementById('customFields').style.display =
        mode === 'custom' ? '' : 'none';
}

function openSettings() {
    var dialog = document.getElementById('scheduleSettingsDialog');
    dialog.showModal();
    // 都道府県リストをロード
    fetch('/api/settings/prefectures')
        .then(function(r) { return r.json(); })
        .then(function(prefs) {
            var sel = document.getElementById('prefecture');
            sel.innerHTML = '';
            prefs.forEach(function(p) {
                var opt = document.createElement('option');
                opt.value = p.name;
                opt.textContent = p.name;
                sel.appendChild(opt);
            });
            // スケジュール設定と検出設定を並行ロード
            return Promise.all([
                fetch('/api/settings/schedule').then(function(r) { return r.json(); }),
                fetch('/api/settings/detection').then(function(r) { return r.json(); }),
            ]);
        })
        .then(function(results) {
            var s = results[0];
            document.getElementById('startMode').value = s.start_mode || 'fixed';
            document.getElementById('startTime').value = s.start_time || '22:00';
            document.getElementById('startOffset').value = s.start_offset_minutes || '0';
            document.getElementById('endMode').value = s.end_mode || 'fixed';
            document.getElementById('endTime').value = s.end_time || '06:00';
            document.getElementById('endOffset').value = s.end_offset_minutes || '0';
            document.getElementById('locationMode').value = s.location_mode || 'preset';
            if (s.prefecture) {
                document.getElementById('prefecture').value = s.prefecture;
            }
            if (s.latitude) {
                document.getElementById('latitude').value = s.latitude;
            }
            if (s.longitude) {
                document.getElementById('longitude').value = s.longitude;
            }
            toggleStartFields();
            toggleEndFields();
            toggleLocationFields();

            var d = results[1];
            document.getElementById('det-min-line-length').value = d.min_line_length || '30';
            document.getElementById('det-canny-threshold1').value = d.canny_threshold1 || '100';
            document.getElementById('det-canny-threshold2').value = d.canny_threshold2 || '200';
            document.getElementById('det-hough-threshold').value = d.hough_threshold || '25';
            document.getElementById('det-max-line-gap').value = d.max_line_gap || '5';
            document.getElementById('det-min-line-brightness').value = d.min_line_brightness || '20.0';
            document.getElementById('det-exclude-bottom-pct').value = d.exclude_bottom_pct || '0';
        });
    document.getElementById('previewResult').style.display = 'none';
}

function saveSettings() {
    var scheduleData = {
        start_mode: document.getElementById('startMode').value,
        start_time: document.getElementById('startTime').value,
        start_offset_minutes: document.getElementById('startOffset').value,
        end_mode: document.getElementById('endMode').value,
        end_time: document.getElementById('endTime').value,
        end_offset_minutes: document.getElementById('endOffset').value,
        location_mode: document.getElementById('locationMode').value,
        prefecture: document.getElementById('prefecture').value,
        latitude: document.getElementById('latitude').value || '',
        longitude: document.getElementById('longitude').value || '',
    };
    var detectionData = {
        min_line_length: document.getElementById('det-min-line-length').value,
        canny_threshold1: document.getElementById('det-canny-threshold1').value,
        canny_threshold2: document.getElementById('det-canny-threshold2').value,
        hough_threshold: document.getElementById('det-hough-threshold').value,
        max_line_gap: document.getElementById('det-max-line-gap').value,
        min_line_brightness: document.getElementById('det-min-line-brightness').value,
        exclude_bottom_pct: document.getElementById('det-exclude-bottom-pct').value,
    };
    Promise.all([
        fetch('/api/settings/schedule', {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(scheduleData),
        }),
        fetch('/api/settings/detection', {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(detectionData),
        }),
    ])
    .then(function() {
        document.getElementById('scheduleSettingsDialog').close();
    });
}

function previewSchedule() {
    // まず現在のフォーム値を一時保存
    var data = {
        start_mode: document.getElementById('startMode').value,
        start_time: document.getElementById('startTime').value,
        start_offset_minutes: document.getElementById('startOffset').value,
        end_mode: document.getElementById('endMode').value,
        end_time: document.getElementById('endTime').value,
        end_offset_minutes: document.getElementById('endOffset').value,
        location_mode: document.getElementById('locationMode').value,
        prefecture: document.getElementById('prefecture').value,
        latitude: document.getElementById('latitude').value || '',
        longitude: document.getElementById('longitude').value || '',
    };
    // 一旦保存してプレビュー
    fetch('/api/settings/schedule', {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data),
    })
    .then(function() {
        return fetch('/api/settings/schedule/preview');
    })
    .then(function(r) { return r.json(); })
    .then(function(p) {
        document.getElementById('previewDate').textContent = p.date_str;
        document.getElementById('previewStart').textContent = p.start_time;
        document.getElementById('previewEnd').textContent = p.end_time;
        document.getElementById('previewResult').style.display = '';
    });
}
</script>
