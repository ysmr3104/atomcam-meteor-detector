{% extends "base.html" %}
{% block title %}{{ date_str }} - atomcam-meteor-detector{% endblock %}
{% block content %}
<h1>Night: {{ date_str }}</h1>

{% if composite_url %}
<section>
    <h2>Composite Image</h2>
    <img src="{{ composite_url }}" alt="Composite" class="composite-img" loading="lazy">
</section>
{% endif %}

{% if video_url %}
<section>
    <h2>Combined Video</h2>
    <video controls class="video-player" preload="metadata">
        <source src="{{ video_url }}" type="video/mp4">
    </video>
    <a href="{{ video_url }}" download style="display:inline-block; margin-top:0.5rem;">Download</a>
</section>
{% endif %}

<section>
    <hgroup>
        <h2>Detected Clips</h2>
        <p>{% if night_output %}{{ night_output.detection_count }}{% else %}0{% endif %} detection(s)</p>
        <p style="display:flex; align-items:center; gap:0.5rem; flex-wrap:wrap; margin-top:0;">
            <button id="rebuild-btn" onclick="triggerRebuild()" class="outline" style="margin:0; padding:0.25rem 0.75rem;">
                Rebuild Composite
            </button>
            <button id="concatenate-btn" onclick="triggerConcatenate()" class="outline" style="margin:0; padding:0.25rem 0.75rem;">
                Concatenate Video
            </button>
            <button onclick="setAllExcluded(false)" class="outline" style="margin:0; padding:0.25rem 0.75rem;">
                Include All
            </button>
            <button onclick="setAllExcluded(true)" class="outline secondary" style="margin:0; padding:0.25rem 0.75rem;">
                Exclude All
            </button>
        </p>
    </hgroup>

    <div class="clip-grid">
        {% for clip in clips %}
        {% if clip.status == 'detected' %}
        {% if clip.line_image_urls %}
        {% for lurl in clip.line_image_urls %}
        <div class="clip-card{% if clip.excluded %} excluded{% endif %}" data-clip-id="{{ clip.id }}">
            <a href="{{ lurl }}" target="_blank">
                <img src="{{ lurl }}" alt="Line {{ loop.index }}" loading="lazy">
            </a>
            <div class="meta">
                <strong>{{ clip.actual_datetime }}:00</strong>
                | line {{ loop.index }}/{{ clip.line_image_urls|length }}
            </div>
            <button class="toggle-btn {% if clip.excluded %}contrast{% else %}outline{% endif %}"
                    onclick="toggleExcluded({{ clip.id }}, {{ 'false' if clip.excluded else 'true' }})">
                {{ "Excluded" if clip.excluded else "Included" }}
            </button>
        </div>
        {% endfor %}
        {% elif clip.image_url %}
        <div class="clip-card{% if clip.excluded %} excluded{% endif %}" data-clip-id="{{ clip.id }}">
            <a href="{{ clip.image_url }}" target="_blank">
                <img src="{{ clip.image_url }}" alt="Detection {{ clip.actual_datetime }}" loading="lazy">
            </a>
            <div class="meta">
                <strong>{{ clip.actual_datetime }}:00</strong>
                | {{ clip.line_count }} line(s)
            </div>
            <button class="toggle-btn {% if clip.excluded %}contrast{% else %}outline{% endif %}"
                    onclick="toggleExcluded({{ clip.id }}, {{ 'false' if clip.excluded else 'true' }})">
                {{ "Excluded" if clip.excluded else "Included" }}
            </button>
        </div>
        {% endif %}
        {% endif %}
        {% endfor %}
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
async function setAllExcluded(excluded) {
    const cards = document.querySelectorAll('.clip-card[data-clip-id]');
    const ids = Array.from(cards).map(c => c.dataset.clipId);
    for (const id of ids) {
        try {
            await fetch(`/api/clips/${id}`, {
                method: 'PATCH',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({excluded: excluded}),
            });
        } catch (e) { /* continue */ }
    }
    location.reload();
}

async function toggleExcluded(clipId, excluded) {
    try {
        const resp = await fetch(`/api/clips/${clipId}`, {
            method: 'PATCH',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({excluded: excluded}),
        });
        if (resp.ok) {
            location.reload();
        } else {
            const err = await resp.json();
            alert('Error: ' + (err.detail || 'Unknown error'));
        }
    } catch (e) {
        alert('Request failed: ' + e.message);
    }
}

async function triggerRebuild() {
    const btn = document.getElementById('rebuild-btn');
    btn.disabled = true;
    btn.textContent = 'Rebuilding...';
    try {
        const resp = await fetch(`/api/nights/{{ date_str }}/rebuild`, {method: 'POST'});
        if (resp.ok) {
            pollRebuild();
        } else {
            btn.disabled = false;
            btn.textContent = 'Rebuild Composite';
            alert('Rebuild failed to start');
        }
    } catch (e) {
        btn.disabled = false;
        btn.textContent = 'Rebuild Composite';
        alert('Request failed: ' + e.message);
    }
}

async function pollRebuild() {
    const btn = document.getElementById('rebuild-btn');
    const interval = setInterval(async () => {
        try {
            const resp = await fetch(`/api/nights/{{ date_str }}/rebuild/status`);
            const data = await resp.json();
            if (data.status === 'completed') {
                clearInterval(interval);
                location.reload();
            } else if (data.status.startsWith('error')) {
                clearInterval(interval);
                btn.disabled = false;
                btn.textContent = 'Rebuild Composite';
                alert('Rebuild error: ' + data.status);
            }
        } catch (e) {
            clearInterval(interval);
            btn.disabled = false;
            btn.textContent = 'Rebuild Composite';
        }
    }, 2000);
}

async function triggerConcatenate() {
    const btn = document.getElementById('concatenate-btn');
    btn.disabled = true;
    btn.textContent = 'Concatenating...';
    try {
        const resp = await fetch(`/api/nights/{{ date_str }}/concatenate`, {method: 'POST'});
        if (resp.ok) {
            pollConcatenate();
        } else {
            btn.disabled = false;
            btn.textContent = 'Concatenate Video';
            alert('Concatenation failed to start');
        }
    } catch (e) {
        btn.disabled = false;
        btn.textContent = 'Concatenate Video';
        alert('Request failed: ' + e.message);
    }
}

async function pollConcatenate() {
    const btn = document.getElementById('concatenate-btn');
    const interval = setInterval(async () => {
        try {
            const resp = await fetch(`/api/nights/{{ date_str }}/concatenate/status`);
            const data = await resp.json();
            if (data.status === 'completed') {
                clearInterval(interval);
                location.reload();
            } else if (data.status.startsWith('error')) {
                clearInterval(interval);
                btn.disabled = false;
                btn.textContent = 'Concatenate Video';
                alert('Concatenation error: ' + data.status);
            }
        } catch (e) {
            clearInterval(interval);
            btn.disabled = false;
            btn.textContent = 'Concatenate Video';
        }
    }, 2000);
}
</script>
{% endblock %}
