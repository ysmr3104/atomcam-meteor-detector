{% extends "base.html" %}
{% block title %}{{ date_str }} - atomcam-meteor-detector{% endblock %}
{% block content %}
<h1>Night: {{ date_str }}</h1>

{% if composite_url or video_url %}
<div class="output-row">
    {% if composite_url %}
    <section>
        <h2>Composite Image</h2>
        <img src="{{ composite_url }}" alt="Composite" class="composite-img" loading="lazy">
    </section>
    {% endif %}

    {% if video_url %}
    <section>
        <h2>Combined Video</h2>
        <video controls class="video-player" preload="metadata">
            <source src="{{ video_url }}" type="video/mp4">
        </video>
        <p style="display:flex; gap:0.5rem; margin-top:0.5rem; align-items:center;">
            <a href="{{ video_url }}" download>Download</a>
            <button id="delete-video-btn" onclick="deleteVideo()" class="outline secondary" style="margin:0; padding:0.25rem 0.75rem;">
                Delete Video
            </button>
        </p>
    </section>
    {% endif %}
</div>
{% endif %}

<section>
    <hgroup>
        <h2>Detected Clips</h2>
        <p>{% if night_output %}{{ night_output.detection_count }}{% else %}0{% endif %} detection(s)</p>
        <p style="display:flex; align-items:center; gap:0.5rem; flex-wrap:wrap; margin-top:0;">
            <button id="redetect-btn" onclick="triggerRedetect()" class="outline" style="margin:0; padding:0.25rem 0.75rem;">
                Re-detect
            </button>
            <button id="redetect-cancel-btn" onclick="cancelRedetect()" class="outline secondary" style="margin:0; padding:0.25rem 0.75rem; display:none;">
                Cancel
            </button>
            <button id="rebuild-btn" onclick="triggerRebuild()" class="outline" style="margin:0; padding:0.25rem 0.75rem;">
                Rebuild Composite
            </button>
            <button id="concatenate-btn" onclick="triggerConcatenate()" class="outline" style="margin:0; padding:0.25rem 0.75rem;">
                Concatenate Video
            </button>
            <button onclick="setAllExcluded(false)" class="outline" style="margin:0; padding:0.25rem 0.75rem;">
                Include All
            </button>
            <button onclick="setAllExcluded(true)" class="outline secondary" style="margin:0; padding:0.25rem 0.75rem;">
                Exclude All
            </button>
            <button id="hide-night-btn" onclick="toggleNightVisibility()" class="outline secondary" style="margin:0; padding:0.25rem 0.75rem;">
                {% if night_output and night_output.hidden %}Unhide Night{% else %}Hide Night{% endif %}
            </button>
        </p>
    </hgroup>

    {% set modal_counter = namespace(index=0) %}
    <div class="clip-grid">
        {% for clip in clips %}
        {% if clip.status == 'detected' %}
        {% if clip.detections %}
        {% for det in clip.detections %}
        {% if det.crop_url %}
        <div class="clip-card{% if det.excluded %} excluded{% endif %}" data-detection-id="{{ det.id }}">
            <img src="{{ det.crop_url }}" alt="Line {{ det.line_index + 1 }}" loading="lazy"
                 style="cursor:pointer" data-modal-index="{{ modal_counter.index }}"
                 onclick="openModal({{ modal_counter.index }})">
            <div class="meta">
                <strong>{{ clip.actual_datetime }}</strong>
                | line {{ det.line_index + 1 }}/{{ clip.detections|length }}
                {% if det.detection_time %}({{ det.detection_time }}){% endif %}
            </div>
            {% if det.id %}
            <button class="toggle-btn {% if det.excluded %}contrast{% else %}outline{% endif %}"
                    onclick="toggleDetection({{ det.id }}, {{ 'false' if det.excluded else 'true' }})">
                {{ "Excluded" if det.excluded else "Included" }}
            </button>
            {% endif %}
        </div>
        {% set modal_counter.index = modal_counter.index + 1 %}
        {% endif %}
        {% endfor %}
        {% elif clip.image_url %}
        <div class="clip-card" data-clip-id="{{ clip.id }}">
            <img src="{{ clip.image_url }}" alt="Detection {{ clip.actual_datetime }}" loading="lazy"
                 style="cursor:pointer" data-modal-index="{{ modal_counter.index }}"
                 onclick="openModal({{ modal_counter.index }})">
            <div class="meta">
                <strong>{{ clip.actual_datetime }}:00</strong>
                | {{ clip.line_count }} line(s)
            </div>
        </div>
        {% set modal_counter.index = modal_counter.index + 1 %}
        {% endif %}
        {% endif %}
        {% endfor %}
    </div>
</section>

<div id="image-modal" class="modal-overlay" style="display:none" onclick="closeModal(event)">
    <button class="modal-close" onclick="closeModal(event)">&times;</button>
    <button id="modal-prev-btn" class="modal-nav modal-prev" onclick="navigateModal(-1, event)">&lsaquo;</button>
    <img id="modal-img" src="" alt="" class="modal-image" onclick="event.stopPropagation()">
    <button id="modal-next-btn" class="modal-nav modal-next" onclick="navigateModal(1, event)">&rsaquo;</button>
    <div id="modal-meta" class="modal-meta"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
async function setAllExcluded(excluded) {
    try {
        const resp = await fetch(`/api/nights/{{ date_str }}/detections/bulk`, {
            method: 'PATCH',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({excluded: excluded}),
        });
        if (resp.ok) {
            location.reload();
        } else {
            alert('Bulk update failed');
        }
    } catch (e) {
        alert('Request failed: ' + e.message);
    }
}

async function toggleDetection(detectionId, excluded) {
    try {
        const resp = await fetch(`/api/detections/${detectionId}`, {
            method: 'PATCH',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({excluded: excluded}),
        });
        if (resp.ok) {
            // Update UI without full reload for faster toggling
            const card = document.querySelector(`[data-detection-id="${detectionId}"]`);
            if (card) {
                const btn = card.querySelector('.toggle-btn');
                if (excluded) {
                    card.classList.add('excluded');
                    btn.classList.remove('outline');
                    btn.classList.add('contrast');
                    btn.textContent = 'Excluded';
                    btn.setAttribute('onclick', `toggleDetection(${detectionId}, false)`);
                } else {
                    card.classList.remove('excluded');
                    btn.classList.remove('contrast');
                    btn.classList.add('outline');
                    btn.textContent = 'Included';
                    btn.setAttribute('onclick', `toggleDetection(${detectionId}, true)`);
                }
            }
        } else {
            const err = await resp.json();
            alert('Error: ' + (err.detail || 'Unknown error'));
        }
    } catch (e) {
        alert('Request failed: ' + e.message);
    }
}

async function triggerRedetect() {
    const btn = document.getElementById('redetect-btn');
    const cancelBtn = document.getElementById('redetect-cancel-btn');
    btn.disabled = true;
    btn.textContent = 'Re-detecting...';
    try {
        const resp = await fetch(`/api/nights/{{ date_str }}/redetect`, {method: 'POST'});
        if (resp.ok) {
            cancelBtn.style.display = '';
            pollRedetect();
        } else if (resp.status === 409) {
            btn.textContent = 'Re-detecting...';
            cancelBtn.style.display = '';
            pollRedetect();
        } else {
            btn.disabled = false;
            btn.textContent = 'Re-detect';
            alert('Re-detection failed to start');
        }
    } catch (e) {
        btn.disabled = false;
        btn.textContent = 'Re-detect';
        alert('Request failed: ' + e.message);
    }
}

async function cancelRedetect() {
    const cancelBtn = document.getElementById('redetect-cancel-btn');
    cancelBtn.disabled = true;
    cancelBtn.textContent = 'Cancelling...';
    try {
        await fetch(`/api/nights/{{ date_str }}/redetect/cancel`, {method: 'POST'});
    } catch (e) {
        // ポーリングがステータスを処理するため無視
    }
}

async function pollRedetect() {
    const btn = document.getElementById('redetect-btn');
    const cancelBtn = document.getElementById('redetect-cancel-btn');
    const interval = setInterval(async () => {
        try {
            const resp = await fetch(`/api/nights/{{ date_str }}/redetect/status`);
            const data = await resp.json();
            if (data.status === 'running') {
                if (data.total > 0) {
                    btn.textContent = `Re-detecting... ${data.processed}/${data.total}`;
                }
            } else if (data.status === 'completed' || data.status === 'cancelled') {
                clearInterval(interval);
                location.reload();
            } else if (data.status.startsWith('error')) {
                clearInterval(interval);
                btn.disabled = false;
                btn.textContent = 'Re-detect';
                cancelBtn.style.display = 'none';
                cancelBtn.disabled = false;
                cancelBtn.textContent = 'Cancel';
                alert('Re-detection error: ' + data.status);
            }
        } catch (e) {
            clearInterval(interval);
            btn.disabled = false;
            btn.textContent = 'Re-detect';
            cancelBtn.style.display = 'none';
            cancelBtn.disabled = false;
            cancelBtn.textContent = 'Cancel';
        }
    }, 2000);
}

async function triggerRebuild() {
    const btn = document.getElementById('rebuild-btn');
    btn.disabled = true;
    btn.textContent = 'Rebuilding...';
    try {
        const resp = await fetch(`/api/nights/{{ date_str }}/rebuild`, {method: 'POST'});
        if (resp.ok) {
            pollRebuild();
        } else {
            btn.disabled = false;
            btn.textContent = 'Rebuild Composite';
            alert('Rebuild failed to start');
        }
    } catch (e) {
        btn.disabled = false;
        btn.textContent = 'Rebuild Composite';
        alert('Request failed: ' + e.message);
    }
}

async function pollRebuild() {
    const btn = document.getElementById('rebuild-btn');
    const interval = setInterval(async () => {
        try {
            const resp = await fetch(`/api/nights/{{ date_str }}/rebuild/status`);
            const data = await resp.json();
            if (data.status === 'completed') {
                clearInterval(interval);
                location.reload();
            } else if (data.status.startsWith('error')) {
                clearInterval(interval);
                btn.disabled = false;
                btn.textContent = 'Rebuild Composite';
                alert('Rebuild error: ' + data.status);
            }
        } catch (e) {
            clearInterval(interval);
            btn.disabled = false;
            btn.textContent = 'Rebuild Composite';
        }
    }, 2000);
}

async function triggerConcatenate() {
    const btn = document.getElementById('concatenate-btn');
    btn.disabled = true;
    btn.textContent = 'Concatenating...';
    try {
        const resp = await fetch(`/api/nights/{{ date_str }}/concatenate`, {method: 'POST'});
        if (resp.ok) {
            pollConcatenate();
        } else {
            btn.disabled = false;
            btn.textContent = 'Concatenate Video';
            alert('Concatenation failed to start');
        }
    } catch (e) {
        btn.disabled = false;
        btn.textContent = 'Concatenate Video';
        alert('Request failed: ' + e.message);
    }
}

async function pollConcatenate() {
    const btn = document.getElementById('concatenate-btn');
    const interval = setInterval(async () => {
        try {
            const resp = await fetch(`/api/nights/{{ date_str }}/concatenate/status`);
            const data = await resp.json();
            if (data.status === 'completed') {
                clearInterval(interval);
                location.reload();
            } else if (data.status.startsWith('error')) {
                clearInterval(interval);
                btn.disabled = false;
                btn.textContent = 'Concatenate Video';
                alert('Concatenation error: ' + data.status);
            }
        } catch (e) {
            clearInterval(interval);
            btn.disabled = false;
            btn.textContent = 'Concatenate Video';
        }
    }, 2000);
}

async function deleteVideo() {
    if (!confirm('結合動画を削除しますか？')) return;
    const btn = document.getElementById('delete-video-btn');
    btn.disabled = true;
    btn.textContent = 'Deleting...';
    try {
        const resp = await fetch(`/api/nights/{{ date_str }}/video`, {method: 'DELETE'});
        if (resp.ok) {
            location.reload();
        } else {
            const err = await resp.json();
            alert('Delete failed: ' + (err.detail || 'Unknown error'));
            btn.disabled = false;
            btn.textContent = 'Delete Video';
        }
    } catch (e) {
        alert('Request failed: ' + e.message);
        btn.disabled = false;
        btn.textContent = 'Delete Video';
    }
}

// ページ読み込み時に実行中のredetectを自動検知
async function checkRedetectOnLoad() {
    try {
        const resp = await fetch(`/api/nights/{{ date_str }}/redetect/status`);
        const data = await resp.json();
        if (data.status === 'running') {
            const btn = document.getElementById('redetect-btn');
            const cancelBtn = document.getElementById('redetect-cancel-btn');
            btn.disabled = true;
            if (data.total > 0) {
                btn.textContent = `Re-detecting... ${data.processed}/${data.total}`;
            } else {
                btn.textContent = 'Re-detecting...';
            }
            cancelBtn.style.display = '';
            pollRedetect();
        }
    } catch (e) {
        // 無視
    }
}
document.addEventListener('DOMContentLoaded', checkRedetectOnLoad);

// モーダルビューアー
const modalImages = [
    {% set mi = namespace(index=0) %}
    {% for clip in clips %}
    {% if clip.status == 'detected' %}
    {% if clip.detections %}
    {% for det in clip.detections %}
    {% if det.crop_url %}
    {url: "{{ det.crop_url }}", meta: "{{ clip.actual_datetime }} | line {{ det.line_index + 1 }}/{{ clip.detections|length }}{% if det.detection_time %} ({{ det.detection_time }}){% endif %}"},
    {% set mi.index = mi.index + 1 %}
    {% endif %}
    {% endfor %}
    {% elif clip.image_url %}
    {url: "{{ clip.image_url }}", meta: "{{ clip.actual_datetime }}:00 | {{ clip.line_count }} line(s)"},
    {% set mi.index = mi.index + 1 %}
    {% endif %}
    {% endif %}
    {% endfor %}
];

let currentModalIndex = 0;

function openModal(index) {
    currentModalIndex = index;
    const modal = document.getElementById('image-modal');
    const img = document.getElementById('modal-img');
    const meta = document.getElementById('modal-meta');
    img.src = modalImages[index].url;
    meta.textContent = modalImages[index].meta;
    modal.style.display = '';
    modal.classList.remove('closing');
    document.body.style.overflow = 'hidden';
    updateNavButtons();
}

function closeModal(event) {
    if (event) event.stopPropagation();
    const modal = document.getElementById('image-modal');
    modal.classList.add('closing');
    setTimeout(() => {
        modal.style.display = 'none';
        modal.classList.remove('closing');
        document.body.style.overflow = '';
    }, 200);
}

function navigateModal(direction, event) {
    if (event) event.stopPropagation();
    const newIndex = currentModalIndex + direction;
    if (newIndex < 0 || newIndex >= modalImages.length) return;
    currentModalIndex = newIndex;
    const img = document.getElementById('modal-img');
    const meta = document.getElementById('modal-meta');
    img.src = modalImages[currentModalIndex].url;
    meta.textContent = modalImages[currentModalIndex].meta;
    updateNavButtons();
}

function updateNavButtons() {
    document.getElementById('modal-prev-btn').style.display = currentModalIndex <= 0 ? 'none' : '';
    document.getElementById('modal-next-btn').style.display = currentModalIndex >= modalImages.length - 1 ? 'none' : '';
}

document.addEventListener('keydown', function(e) {
    const modal = document.getElementById('image-modal');
    if (modal.style.display === 'none') return;
    if (e.key === 'Escape') closeModal(e);
    else if (e.key === 'ArrowLeft') navigateModal(-1, e);
    else if (e.key === 'ArrowRight') navigateModal(1, e);
});

async function toggleNightVisibility() {
    const btn = document.getElementById('hide-night-btn');
    const currentlyHidden = btn.textContent.trim() === 'Unhide Night';
    const newHidden = !currentlyHidden;
    btn.disabled = true;
    try {
        const resp = await fetch('/api/nights/{{ date_str }}/visibility', {
            method: 'PATCH',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({hidden: newHidden}),
        });
        if (resp.ok) {
            if (newHidden) {
                window.location.href = '/';
            } else {
                btn.textContent = 'Hide Night';
                btn.disabled = false;
            }
        } else {
            btn.disabled = false;
            alert('非表示の切り替えに失敗しました');
        }
    } catch (e) {
        btn.disabled = false;
        alert('リクエストに失敗しました: ' + e.message);
    }
}
</script>
{% endblock %}
